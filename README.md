# 区块链的技术
## 1. 写在前面
## 2. 目录
1. 写在前面
2. 目录
3. 初识区块链
	1. 哈希函数
	2. 共识算法
	3. 数字签名
	4. 去中心化网络
4. 区块链的进化过程
	1. 比特币——首个成功实现的加密货币
		1. 比特币区块结构
		2. 比特币共识算法
		3. 比特币脚本与扩展应用
		4. 比特币与区块链1.0时代
	2. 以太坊——从交易系统到区块链平台
		1. 以太坊区块结构
		2. 以太坊的运行
		3. 智能合约与去中心化应用
	3. 更多的探索

## 3. 初识区块链
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;区块链是一种新型的分布式数据库，由一个个基本的数据块——区块串联而成。相比于传统的数据库，区块链最大的不同在于其数据不是只有一个特殊的参与方（即所谓的“中心”）有权力负责收集、维护、整理和更新，所有参与者都有平等的权力完成这项工作（即所谓的“去中心化”）。一个区块链系统的所有数据面向全体参与者公开，单个参与者对数据库的任何行为必须得到全体成员（注释：严格来讲应为“大多数参与者”，后文中出现的“全体成员”均为此意）的认可才能生效。因此，一旦某数据经全体成员而写入区块链，篡改将变得极其困难，这极大地提高了区块链储存数据的安全性。
### 3.1. 哈希（hash）函数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;哈希函数并非是区块链独有的技术，但在区块链中起到极其重要的作用。区块链中的哈希函数是指这样的一个函数，它将一段任意长度的字符串作为输入值进行处理，生成一段固定长度的字符串（该字符串被称为原字符串的哈希值）。同时，这个函数还具有以下两大特点：

* 不存在两条不同的字符串，它们的哈希值相同。这里的“不存在”指统计意义上的不存在。事实上，由于哈希函数的输入值是任意长度而输出值却是固定长度，输入值的数量要远远超过可能的输出值的数量，必定存在不同的字符串使得它们的哈希值相同。但对于目前区块链领域所使用的哈希函数（注释：曾经被使用的MD5哈希函数，科学家对其多年的研究后找到了两条本身不同但哈希值相同的字符串，因此这个函数现在已不再用于区块链），人们还没有找到这样的两条字符串，同时也没有找到可行的寻找方法。所以当我们发现两条字符串的哈希值相同时，由于这两条字符串不同的可能性微乎其微，我们有充足的把握认为这两条字符串相同。
* 已知某字符串的哈希值，不可能求出这个字符串（即哈希函数的不可逆性）。这里的“不可能”同样也不是指数学意义上的“不可能”，而是指目前人们还没有找出可行的求出方法或者逼近这段字符串的方法，只能通过类似穷举的方式一次次产生随机的字符串计算它的哈希值进行尝试。由于输入值是任意长度的，这将花费巨大的时间和计算资源，以至于在实践中根本不可行。同样，给定一个非常小的哈希值取值范围，我们只有通过大量的穷举试验，才最终有可能找到一段字符串使它的哈希值落在这个取值范围内。
               
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;哈希函数的这些特点，赋予了它很多的用处。比如我们要检查两块很大的数据是否相同，只需要检查它们的哈希值是否相同。又如我们只需要记住一块数据的哈希值就可以防止它被篡改。一旦这块数据被人篡改，它的哈希值也将随之变化，与我们手中的哈希值无法对应。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;哈希函数承载着将一个个区块串联成链的工作。在区块链里，每一个区块都包含上一个区块的哈希值。因此若某人想篡改某一个区块的内容而不被发觉，就必须篡改下一个区块的内容，从而必须对这个区块之后的每一个区块进行篡改。所以我们只要记录好最后一个区块的内容，就可以对整个区块链所存储数据是否被篡改进行验证。

### 3.2. 共识算法
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;设想在一个区块链网络中有一个特殊的参与者，他负责这些任务：

* 向每一个参与者提供当前区块链中储存的所有数据。
* 向每一个参与者提供当前区块链中储存的所有数据。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果这个参与者是可靠的，那么这个区块链数据库就是可靠的：普通用户可以向该参与者提交新数据、查询旧数据；该参与者则主要负责区块链的维护和更新工作。事实上，这样的“区块链”在协作方式上和传统的数据库没有任何区别。他们都依赖于一个中心——一个特殊的负有“维护和更新数据库”责任的参与者，其他参与者直接和中心进行数据交流。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而在一个去中心化的网络里，完成数据库的维护和更新工作异常困难。在一个去中心化的网络里，没有那个负有特殊责任的参与者，网络中的所有参与者都可以收集大家发布的数据、在一个已经存在的区块之后连上打包成的新区块。这样从第一个区块（也成为“创世区块”）起每一个区块后将有若干区块相连，所有的区块共同构成区块树。我们需要一个算法让全体成员同意某一条从根区块到叶区块的路径其中所包含的数据作为历史数据。换句话说，从一个所有成员都认可的历史版本的数据库出发，不同的参与者对该数据库应该添加哪些数据意见不一，这些数据可能截然相反完全无法兼容。我们需要一个算法让全体成员对添加哪些数据达成共识。这就是一个区块链项目的核心——共识算法。（注释：如果共识无法达成，那么区块链将永久分叉出两个子链，参与者在各自支持的链上继续制造新的区块。这就是区块链的“分叉”)

![Block Tree](pics/block_tree.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;自从中本聪第一次推出区块链的概念以来，区块链从业者相继发明了工作量证明机制（PoW）、权益证明机制（PoS）、股份授权证明机制（DPoS）等共识算法。这些共识算法各有不同，但总体来讲，都必须回答以下几个问题：

* 如何确保参与者制造符合要求、数据真实的区块？这个问题不难解决。由于整个网络去中心化，每个参与者都要检验他所接收到的新区快。不合法的区块无法被检验通过，自然不会被接受。因此每个参与者如果不想浪费时间和精力，必定选择制造合法区块。因此，本文后面关于共识算法的具体分析，不再讨论区块不合法的情况。
* 如何使全体成员对某个版本的数据库达成共识？这是一个共识算法关键解决的问题。
* 如何使全体成员达成共识的时间尽可能短？区块链出现暂时性分叉时，哪个版本的数据库为全体成员最终认可的版本尚无定论，用户自然不放心使用他所见到的数据库中的内容。也即，区块链的分叉现象不利于用户使用。一个成熟的共识算法应尽可能减少分叉现象的出现，保持数据库以一条区块链的形式不断延伸。
* 如何保持数据库的稳定？当全体成员改变共识，抛却当前主链而选择认可一条分叉链时，数据库部分内容会认为非法而遭到舍弃。这对使用这些被舍弃内容的用户带来不变，甚至有可能造成巨大经济损失。因此，一个成熟的共识算法必须维持全体成员共识的稳定，要在尽可能多的参与者“蓄意”分叉的情况下维持主链被大多数成员认可。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比特币作为第一个成功的区块链项目，采用工作量证明机制的共识算法。这种共识算法要求制造区块的人解决一个计算量巨大的难题来证明其制造区块过程中耗费大量精力。但这种共识算法因为计算量大耗费电能、数据更新速度低、容易被拥有更多计算资源的参与者控制等问题而被人诟病。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为解决工作量证明机制的种种问题，权益证明机制和股份授权证明机制分别被提出。这些共识算法的具体内容，将会在第二节具体叙述。

### 3.3. 数字签名
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在真实世界里，为了确认某数据确实由某人授权，通常需要这个人在记录数据的公文上签名。其他人通过验证签名来确保数据的真实性。同样地，在虚拟世界里，数据的发布者也需要在数据上签署数字签名来方便他人验证数据的真实性。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数字签名和传统签名有相同之处。对于不同的签名人，无论所签的数据是否相同，数字签名必须不同。但二者又有区别。传统签名由于直接被签在对应的公文上，无法被拷贝伪造。而在虚拟世界里，所有的内容本质上都是一条字符串。别有用心的人完全可以拷贝下某条数据上的签名并附着于其他数据上以伪造签名。因此对于不同的数据，即使签名人相同，传统签名可以相同但数字签名必须不同。这是一个数字签名技术必须拥有的条件。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;非对称加密算法就是用于解决这个问题。在非对称加密算法中，参与者可以通过一定的过程产生一对公钥和私钥，公钥作为区块链网络里自己的身份，被全网知晓。私钥则用于签名，需要保密。当参与者想发布一条数据时，可用私钥对这条数据加密得到数字签名，然后将数据与数字签名一同在全网广播。验证者通过数据发出者的公钥对数字签名进行解密，将解密的结果与接收到的数据相比对，如果相同则验证成功，如果不同则验证失败。对于想要伪造他人发布数据的人，由于他无法获得伪造对象的私钥，无法伪造对应的数字签名，因此他广播的数据将无法被验证自然不会得逞。

![Digital Signature](pics/digital_signature.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然而这里还有一个问题。当某人想发布一条很长的数据时，加密和解密的过程将变得十分复杂。现在通常采取的方法是，充分利用哈希函数输出值为固定长度的优势，数据发布者改为对数据的哈希值进行加密。验证者通过比对收到数据的哈希值和解密出来的哈希值是否相同，来判断该数据是否为真。

### 3.4. 去中心化网络
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;区块链在一个去中心化的网络上运行，所谓去中心化的网络，即点对点网络，与传统的中心化网络结构完全不同。在传统的中心化网络结构里，有一个特殊的“中心”参与者。想要登陆到该网络的用户只需要和这个中心进行连接。中心化网络中的参与者若想要上传到数据库任何数据，只需要将数据告诉中心，由中心代为上传。如果他想获取当前的数据库内容，只需要向中心索取。而在去中心化的网络中，所有参与者人人平等，每个参与者只与其中一些参与者建立连接。去中心化的网络完成用户登陆、上传数据、查询数据的过程要复杂一些。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当一个新用户想要登陆到这个去中心化网络时，他只需要与已知的在登陆状态的其他用户建立连接。如果他想扩大自己连接的用户数量，可以向已连接的用户询问他们所连接的其他用户，再与那些用户进行连接。当他想上传一条数据时，需要向他已连接的其他用户广播这条数据。然后其他用户又会把这条数据广播给他们连接的用户。这样的过程持续下去，最终这个网络的想要制造区块的参与者都会接收到这条数据。而当他想获取当前数据库内容时，只需要询问与他连接的其他在线用户。

![Centralized VS Decentralized](pics/centralized_vs_decentralized.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注意，参与去中心化网络的用户没有义务一定向他人代为广播数据（他也可以只接受数据而不向他人继续广播，甚至向他人广播虚假数据），也没有义务一定回答其他用户查询的要求（他可以闭口不言，也可以答非所问）。但由于这样做并不能给他带来任何直接利益，因此可以认为这样损人不利己的用户只占少数。只要每个用户连接到足够多其他的用户，那么他一定连接到足够多“行为正常”的用户，从而确保自己的行为不受干扰。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由此可见，去中心化网络的数据上传和查询效率比中心化网络相差许多。但是去中心化网络比中心化网络稳定、安全。中心化网络的运行严重依赖于中心的情况，中心承载着网络中所有数据的上传、查询工作，这要求中心的网络设备性能足够优秀。一旦中心的网络设备发生障碍，整个网络将面临瘫痪。此外，该网络的运行也严重依赖于中心处参与者的“道德水平”。一旦该参与者随意上传虚假数据，整个数据库将面临瘫痪。而在去中心化网络中，在任一小部分参与者“肆意破坏”或者他们的设备发生障碍的情况下，数据库仍然保持安全并正常更新。这是去中心化网络无可比拟的优点。

## 区块链的进化过程